<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Mass balance • daisyrVis</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mass balance">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">daisyrVis</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.4.0000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/compare-simulated-and-measured-data.html">Compare simulated and measured data</a></li>
    <li><a class="dropdown-item" href="../articles/daisy-01-reading-dlf-files.html">Reading dlf files</a></li>
    <li><a class="dropdown-item" href="../articles/daisy-02-plotting-dlfs.html">Plotting dlfs</a></li>
    <li><a class="dropdown-item" href="../articles/mass-balance.html">Mass balance</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Mass balance</h1>
            
      

      <div class="d-none name"><code>mass-balance.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://daisy-model.github.io/daisyrVis/">daisyrVis</a></span><span class="op">)</span></span></code></pre></div>
<p>We are going to read a dlf file and then calculate, summarize and
plot mass balance. For this we will use the soil chemical log bundled
with <code>daisyrVis</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package<span class="op">=</span><span class="st">"daisyrVis"</span><span class="op">)</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"hourly/P2D-Daily-Soil_Chemical_110cm.dlf"</span><span class="op">)</span></span>
<span><span class="va">dlf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_dlf.html">read_dlf</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="co">## We don't need timestamps for the mass balance calculation, but we need it for</span></span>
<span><span class="co">## plotting later.</span></span>
<span><span class="va">dlf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/daisy_time_to_timestamp.html">daisy_time_to_timestamp</a></span><span class="op">(</span><span class="va">dlf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dlf</span><span class="op">@</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "year"                    "month"                  </span></span>
<span><span class="co">#&gt;  [3] "mday"                    "hour"                   </span></span>
<span><span class="co">#&gt;  [5] "In_Matrix"               "In_Biopores"            </span></span>
<span><span class="co">#&gt;  [7] "Leak_Matrix"             "Leak_Biopores"          </span></span>
<span><span class="co">#&gt;  [9] "Biopores to matrix"      "Matrix to biopores"     </span></span>
<span><span class="co">#&gt; [11] "Tillage"                 "Drain_Soil"             </span></span>
<span><span class="co">#&gt; [13] "Drain_Biopores"          "Drain_Biopores_Indirect"</span></span>
<span><span class="co">#&gt; [15] "External"                "Uptake"                 </span></span>
<span><span class="co">#&gt; [17] "Decompose"               "Transform"              </span></span>
<span><span class="co">#&gt; [19] "Content"                 "Biopores"               </span></span>
<span><span class="co">#&gt; [21] "Error"                   "time"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dlf</span><span class="op">@</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 11665</span></span></code></pre></div>
<p>In order to do a mass balance calculation, we need to define which
variables are input, output and content variables. In this case we
use</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"In_Matrix"</span>, <span class="st">"In_Biopores"</span>, <span class="st">"External"</span>, <span class="st">"Transform"</span>, <span class="st">"Tillage"</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Decompose"</span>, <span class="st">"Leak_Matrix"</span>, <span class="st">"Leak_Biopores"</span>, <span class="st">"Drain_Soil"</span>,</span>
<span>            <span class="st">"Drain_Biopores"</span>, <span class="st">"Uptake"</span><span class="op">)</span></span>
<span><span class="va">content</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Content"</span>, <span class="st">"Biopores"</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="mass-balance-summary">Mass balance summary<a class="anchor" aria-label="anchor" href="#mass-balance-summary"></a>
</h2>
<p>We can use the function <code>mass_balance_summary</code> to
summarize the mass balance at the final timestep. The result is a list
containing the sum of each input and the total input; the sum of each
output and the total output; the value of each initial content and total
initial content; the value of each final content and total final
content; and the final balance calculation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mass_balance_summary.html">mass_balance_summary</a></span><span class="op">(</span><span class="va">dlf</span>, <span class="va">input</span>, <span class="va">output</span>, <span class="va">content</span><span class="op">)</span></span>
<span><span class="va">mbs</span><span class="op">$</span><span class="va">Inputs</span></span>
<span><span class="co">#&gt;   In_Matrix In_Biopores    External   Transform     Tillage       Total </span></span>
<span><span class="co">#&gt;     0.00000     0.00000     0.00000    68.19174     0.00000    68.19174</span></span>
<span><span class="va">mbs</span><span class="op">$</span><span class="va">Outputs</span></span>
<span><span class="co">#&gt;      Decompose    Leak_Matrix  Leak_Biopores     Drain_Soil Drain_Biopores </span></span>
<span><span class="co">#&gt;     44.3881377     13.4851340      0.3371014      0.3095327     13.5879370 </span></span>
<span><span class="co">#&gt;         Uptake          Total </span></span>
<span><span class="co">#&gt;      0.0000000     72.1078427</span></span>
<span><span class="va">mbs</span><span class="op">$</span><span class="va">InitialContent</span></span>
<span><span class="co">#&gt;   Content    Biopores   Total</span></span>
<span><span class="co">#&gt; 1 60.5101 9.80239e-19 60.5101</span></span>
<span><span class="va">mbs</span><span class="op">$</span><span class="va">FinalContent</span></span>
<span><span class="co">#&gt;   Content   Biopores    Total</span></span>
<span><span class="co">#&gt; 1  56.593 0.00147698 56.59448</span></span>
<span><span class="va">mbs</span><span class="op">$</span><span class="va">Balance</span></span>
<span><span class="co">#&gt;      Input   Output InOutChange InitialContent FinalContent ContentChange</span></span>
<span><span class="co">#&gt; 1 68.19174 72.10784    3.916101        60.5101     56.59448     -3.915623</span></span>
<span><span class="co">#&gt;        Balance</span></span>
<span><span class="co">#&gt; 1 0.0004779899</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="mass-balance-at-each-timestep">Mass balance at each timestep<a class="anchor" aria-label="anchor" href="#mass-balance-at-each-timestep"></a>
</h2>
<p>We can use the function <code>mass_balance</code> to calculate a mass
balance at each timestep. When calculating mass balance we can either
use the initial content as reference or get total mass</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mb_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mass_balance.html">mass_balance</a></span><span class="op">(</span><span class="va">dlf</span>, <span class="va">input</span>, <span class="va">output</span>, <span class="va">content</span><span class="op">)</span></span>
<span><span class="va">mb_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mass_balance.html">mass_balance</a></span><span class="op">(</span><span class="va">dlf</span>, <span class="va">input</span>, <span class="va">output</span>, <span class="va">content</span>, <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><code>mass_balance</code> returns a <code>Dlf</code> object with a
mass balance calculation for each timestep</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mb_ref</span><span class="op">@</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "year"                    "month"                  </span></span>
<span><span class="co">#&gt;  [3] "mday"                    "hour"                   </span></span>
<span><span class="co">#&gt;  [5] "In_Matrix"               "In_Biopores"            </span></span>
<span><span class="co">#&gt;  [7] "Leak_Matrix"             "Leak_Biopores"          </span></span>
<span><span class="co">#&gt;  [9] "Biopores to matrix"      "Matrix to biopores"     </span></span>
<span><span class="co">#&gt; [11] "Tillage"                 "Drain_Soil"             </span></span>
<span><span class="co">#&gt; [13] "Drain_Biopores"          "Drain_Biopores_Indirect"</span></span>
<span><span class="co">#&gt; [15] "External"                "Uptake"                 </span></span>
<span><span class="co">#&gt; [17] "Decompose"               "Transform"              </span></span>
<span><span class="co">#&gt; [19] "Content"                 "Biopores"               </span></span>
<span><span class="co">#&gt; [21] "Error"                   "time"                   </span></span>
<span><span class="co">#&gt; [23] "input_sum"               "output_sum"             </span></span>
<span><span class="co">#&gt; [25] "content_sum"             "balance"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mb_ref</span><span class="op">@</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 11665</span></span></code></pre></div>
<div class="section level3">
<h3 id="plotting-mass-balance">Plotting mass balance<a class="anchor" aria-label="anchor" href="#plotting-mass-balance"></a>
</h3>
<p>We can plot the mass balance calculation with
<code>plot_mass_balance</code>. This will produce a controlchart plot,
where each point is plotted alongside lines indicating mean, mean ± 2
standard deviations, mean ± 3 standard deviations. The point of the plot
is twofold, highlight points with large deviation and highlight
systematic change in deviations. We want to check that the magnitude of
deviations is acceptable, and that the distribution of deviations is
consistent over time.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mass_balance.html">plot_mass_balance</a></span><span class="op">(</span><span class="va">mb_ref</span>, <span class="st">"time"</span>, <span class="st">" - Initial content as reference"</span><span class="op">)</span></span></code></pre></div>
<p><img src="mass-balance_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mass_balance.html">plot_mass_balance</a></span><span class="op">(</span><span class="va">mb_total</span>, <span class="st">"time"</span>, <span class="st">" - Total content"</span><span class="op">)</span></span></code></pre></div>
<p><img src="mass-balance_files/figure-html/unnamed-chunk-7-2.png" width="672"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Silas Ørting.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
